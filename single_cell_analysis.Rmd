---
title: "はじめてのシングルセル解析：JIA滑膜CITE-seqデータの解析 Part 1"
subtitle: "シングルセル解析の最初の一歩"
author: 
  name: 稲毛 純（Inamo Jun）
  affiliation: "慶應義塾大学医学部 微生物学・免疫学教室"
date: "`r format(Sys.time(), '%Y年%m月%d日')`"
output:
  BiocStyle::html_document:
    toc_float: true
---



```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE, 
  error = FALSE, 
  message = FALSE, 
  warning = FALSE,
  fig.align = "center"
)
set.seed(123) # 再現性のためのシード設定
# パッケージの読み込み
library(BiocStyle)
library(Seurat)
library(patchwork) # グラフを並べるためのパッケージ

```

---

# イントロダクション：シングルセル解析とは？

この実習では、**若年性特発性関節炎（JIA）**の患者さんの関節組織（滑膜）から得られたデータを使用します。

- 論文：Bolton C, Mahony CB, Clay E, Nisa PR, Lomholt S, Hackland A, Chin PS, Smith CG, Alexiou V, Nguyen HD, Thyagarajan M, Sheikh Z, Davis P, Chippington S, Compeyrot-Lacassagne S, Davda S, Foley C, Turtsevich I, Ingledow B, Kupiec K, Kelly J, Hanlon MM, DiCarlo E, Jones LJ, Smith SL, Eyre S, Neag G, Kemble S, Madhu R, Palshikar MG, Korsunsky I, Gao C, Tran M, Dendrou C, Buckley CD, Coles MC, Raza K; MAPJAG Study Group; Gravallese E, Filer A, Wei K, Al-Abadi E, Rosser EC, Wedderburn LR, Croft AP; Multiomic Analysis of Paediatric Joint and Gut inflammation (MAPJAG) study group. Synovial tissue atlas in juvenile idiopathic arthritis reveals pathogenic niches associated with disease severity. Sci Transl Med. 2025 Jul 2;17(805):eadt6050. doi: 10.1126/scitranslmed.adt6050.
- データセット：GEO Accession [GSE278962](https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE278962)

今回のデータは **CITE-seq (Cell Indexing of Transcriptomes and Epitopes by sequencing)** という手法で得られたもので、以下の2つの情報を同時に持っています：

1. **RNA (Transcriptome):** 細胞内でどの遺伝子がどれくらい働いているか
2. **ADT (Antibody-Derived Tags):** 細胞の表面にどんなタンパク質が出ているか

これらを解析することで、「この患者さんの関節には、どんな種類の免疫細胞がいて、何が悪さをしているのか？」を細胞1つ1つのレベルで明らかにできます。
本日扱うのは、RNAのみの解析ですが、ADTも同時に解析することで、さらに深い理解が得られます。

---

# データの読み込み (Load Dataset)

まずは、解析の準備として、Rの作業ディレクトリを確認してみましょう。データが保存されている場所と一致しているか確認してください。

```{r}
print(getwd())
```

まず、解析の土台となるデータを読み込みます。

**注意:** `ref_sc_jia_path` は、異なるデータを解析する場合は、PC上のデータが保存されているフォルダパスに書き換えてください。

```{r}
# データの保存場所を指定
ref_sc_jia_path = "./../../../single_cell_FanLab/projects/JIA_CITEseq/GSE278962/"

# 1. RNAカウントデータの読み込み
rna_counts <- ReadMtx(
  mtx = paste0(ref_sc_jia_path, "matrix.mtx.gz"),
  cells = paste0(ref_sc_jia_path, "barcodes.tsv.gz"),
  features = paste0(ref_sc_jia_path, "genes.tsv.gz")
)

# 2. タンパク質(ADT)カウントデータの読み込み
adt_counts <- ReadMtx(
  mtx = paste0(ref_sc_jia_path, "ADT_matrix.mtx.gz"),
  cells = paste0(ref_sc_jia_path, "ADT_barcodes.tsv.gz"),
  features = paste0(ref_sc_jia_path, "ADT_genes.tsv.gz")
)

# 3. メタデータ（細胞ごとの付加情報）の読み込み
metadata <- read.table(paste0(ref_sc_jia_path, "meta.tsv"), 
                       header = TRUE, sep = "\t", row.names = 1)

# 4. Seuratオブジェクトの作成
# Seuratオブジェクトは、RNA、ADT、メタデータをすべてまとめて管理する「大きな箱」です
syno.rna.jia <- CreateSeuratObject(counts = rna_counts, meta.data = metadata, project = "JIA_CITEseq")

# ADTデータを追加のレイヤー（Assay）として登録します
syno.rna.jia[["ADT"]] <- CreateAssayObject(counts = adt_counts)

# 細胞ごとのラベル（型）を整理
syno.rna.jia@meta.data$ct = syno.rna.jia@meta.data$label15
syno.rna.jia@meta.data$ct_subtype = syno.rna.jia@meta.data$clusters2312

```

---

# 品質管理 (Quality Control)

実験の過程で壊れてしまった細胞や、2つの細胞がくっついて1つとしてカウントされてしまった「ダブレット」を取り除く重要な工程です。

* **nFeature_RNA:** 検出された遺伝子の数。少なすぎると死細胞、多すぎるとダブレットの可能性があります。
* **percent.mt:** ミトコンドリア遺伝子の割合。細胞がダメージを受けるとミトコンドリアの割合が増える傾向にあります。

```{r, fig.height=4, fig.width=10}
# ミトコンドリア遺伝子の割合を計算
syno.rna.jia[["percent.mt"]] <- PercentageFeatureSet(syno.rna.jia, pattern = "^MT-")

# バイオリンプロットでデータの分布を確認
VlnPlot(syno.rna.jia, features = c("nFeature_RNA", "nCount_RNA", "percent.mt"), ncol = 3, pt.size = 0)
print("各指標の要約統計量:")
summary(syno.rna.jia$nFeature_RNA)
summary(syno.rna.jia$nCount_RNA)        
summary(syno.rna.jia$percent.mt)
```

### フィルタリングの実行

以下の基準で、解析に適さない細胞を除外します。

* 遺伝子数が 200個より多く、5000個未満
* ミトコンドリア遺伝子が 5% 未満

```{r}
syno.rna.jia <- subset(syno.rna.jia, subset = nFeature_RNA > 200 & nFeature_RNA < 5000 & percent.mt < 5)

```

---

# 正規化と高変動遺伝子の選出

### 正規化 (Normalization)

細胞ごとに読み取れた情報の総量（シーケンス深さ）が異なるため、これらを公平に比較できるように値を揃えます。
一般的に、各細胞の総カウント数を10,000に合わせ、計算しやすいように対数（Log）変換を行います。

```{r}
DefaultAssay(syno.rna.jia) <- "RNA"
syno.rna.jia <- NormalizeData(syno.rna.jia, normalization.method = "LogNormalize", scale.factor = 10000)

```

### 高変動遺伝子の選出 (Feature Selection)

数万ある遺伝子のうち、すべての遺伝子が細胞の分類に役立つわけではありません。細胞間で発現の差が激しい「特徴的な遺伝子」を2000個選び出します。

```{r, fig.height=4, fig.width=10}
syno.rna.jia <- FindVariableFeatures(syno.rna.jia, selection.method = "vst", nfeatures = 2000)

# 最も変動の大きい上位10個を表示
top10 <- head(VariableFeatures(syno.rna.jia), 10)
plot1 <- VariableFeaturePlot(syno.rna.jia)
plot2 <- LabelPoints(plot = plot1, points = top10, repel = TRUE)
plot1 + plot2

```

---

# 次元削減 (Dimensionality Reduction)

数千もの遺伝子情報をそのまま扱うのは複雑すぎるため、データの主要なエッセンスを取り出します。

1. **Scaling:** 遺伝子ごとに発現量の平均を0、分散を1にします。これにより、発現量が極端に多い遺伝子に解析が引きずられるのを防ぎます。
2. **PCA (主成分分析):** データの情報をなるべく維持したまま、少数の「主成分」にまとめます。

**主成分とは？:**主成分とは、データのばらつきを最大限に表現する新しい軸のことです。例えば、PCAの第1主成分は、データの中で最も大きなばらつきを説明する方向を示します。これにより、数千の遺伝子の情報を数十の主成分に圧縮できます。

```{r}
syno.rna.jia <- ScaleData(syno.rna.jia)
syno.rna.jia <- RunPCA(syno.rna.jia, features = VariableFeatures(object = syno.rna.jia))

```

### PCAの結果確認

PCAでまとめられた上位の成分に、どのような遺伝子が寄与しているかを確認します。

```{r, fig.height=15, fig.width=7}
DimHeatmap(syno.rna.jia, dims = 1:15, cells = 500, balanced = TRUE)

```

続いて、エルボープロットを用いて、どの主成分まで解析に使用するかを判断します。エルボープロットは、主成分の数とそれぞれの主成分が説明するデータのばらつきの割合を示すグラフです。グラフ上で「ひじ」のような形状が現れるポイントが、適切な主成分の数を示しています。

```{r}
ElbowPlot(syno.rna.jia)
```


---

# クラスタリングと可視化 (UMAP)

似た者同士の細胞をグループ化（クラスタリング）し、2次元の地図（UMAP）に描画します。

以下では、便宜的に最初の10個の主成分を使用して、次の解析ステップに進みます。

```{r, fig.height=5, fig.width=6}
# 細胞間の近さを計算し、グループに分ける
syno.rna.jia <- FindNeighbors(syno.rna.jia, dims = 1:10)
syno.rna.jia <- FindClusters(syno.rna.jia, resolution = 0.5)

# UMAPの実行（多次元データを2次元に要約して配置する手法）
syno.rna.jia <- RunUMAP(syno.rna.jia, dims = 1:10)

# 可視化
DimPlot(syno.rna.jia, reduction = "umap", label = TRUE)

```

クラスターごとの数を確認してみましょう。
```{r}
table(syno.rna.jia$seurat_clusters)

```

データセットを保存します。

```{r}
saveRDS(syno.rna.jia, file = "./JIAsyno_CITEseq_full.rds")
```

---

# マーカー遺伝子の探索

各クラスターを特徴づける遺伝子（マーカー遺伝子）を探すことで、「クラスター0はT細胞だ」「クラスター2はB細胞だ」といった正体を突き止めることができます。

```{r}
# 例：クラスター2で特徴的に発現している遺伝子を探す
cluster2.markers <- FindMarkers(syno.rna.jia, ident.1 = 2)
head(cluster2.markers, n = 5)

```

---


# T細胞集団を抽出

続いて、自分で興味のある細胞集団を抽出してみましょう。例えば、どのクラスターがT細胞であるか調べてみましょう。
CD3EはT細胞のマーカー遺伝子の一つです。これが高く発現しているクラスターを探します。

```{r, fig.height=5, fig.width=6}

FeaturePlot(syno.rna.jia, features = "CD3E")

```

続いて、Violin plotで確認してみましょう。

```{r, fig.height=5, fig.width=6}
VlnPlot(syno.rna.jia, features = "CD3E", pt.size = 0)

```

クラスター0, 1, 2, 3, 16, 20がT細胞集団であることがわかります。これらのクラスターをまとめて、T細胞集団として抽出してみましょう。

```{r}
# クラスター0, 1, 2, 3, 16, 20をまとめてT細胞集団として抽出
t.cell.cluster <- subset(syno.rna.jia, idents = c(0, 1, 2, 3, 16, 20))

```


細胞の数を確認してみます。

```{r}
t.cell.cluster

```

これが、先ほどのtable(syno.rna.jia$seurat_clusters)で確認したクラスター0, 1, 2, 3, 16, 20の細胞数の合計と一致するはずです。

```{r}
sum(table(syno.rna.jia$seurat_clusters)[c("0", "1", "2", "3", "16", "20")])

```


便宜的にダウンサンプルします。

```{r}

# 再現性のためにシード値を固定します
set.seed(123)

# 1. 保持したい割合を指定（例：全体の10%を抽出する場合）
keep_fraction <- 0.1

# 2. 各クラスター（Idents）ごとに指定した割合のセル名を抽出
cells_to_keep <- unlist(lapply(levels(t.cell.cluster), function(cluster) {
  # 当該クラスターに所属するセル名を取得
  cluster_cells <- WhichCells(t.cell.cluster, idents = cluster)
  
  # 抽出するセル数を計算（最低1セルは残すように max(1, ...) を使用）
  num_to_sample <- max(1, floor(length(cluster_cells) * keep_fraction))
  
  # ランダムにサンプリング
  sample(cluster_cells, size = num_to_sample)
}))

# 3. 抽出したセルのみを保持した新しいSeuratオブジェクトを作成
t.cell.cluster_downsampled <- subset(t.cell.cluster, cells = cells_to_keep)

# --- 検証：比率が変わっていないか確認 ---
print("--- 元のデータの比率 ---")
prop.table(table(Idents(t.cell.cluster)))

print("--- ダウンサンプル後の比率 ---")
prop.table(table(Idents(t.cell.cluster_downsampled)))
```

```{r}
t.cell.cluster_downsampled
```

このデータを使用するために、RDSファイルとして保存しておきましょう。

```{r, hide=TRUE}

saveRDS(t.cell.cluster_downsampled, file = "./JIAsyno_CITEseq_T_full.rds")

```


```{r}

t.cell.cluster_downsampled_no_anno = t.cell.cluster_downsampled
t.cell.cluster_downsampled_no_anno@meta.data$clusters2312 = NULL
t.cell.cluster_downsampled_no_anno@meta.data$ct_subtype = NULL
t.cell.cluster_downsampled_no_anno@meta.data$ct = NULL
t.cell.cluster_downsampled_no_anno@meta.data$label15 = NULL
t.cell.cluster_downsampled_no_anno@meta.data$simple15 = NULL
t.cell.cluster_downsampled_no_anno@meta.data$label15s = NULL
t.cell.cluster_downsampled_no_anno@meta.data$global1 = NULL
t.cell.cluster_downsampled_no_anno@meta.data$T_clonotype_id = NULL
t.cell.cluster_downsampled_no_anno@meta.data$T_cdr3s_aa = NULL
t.cell.cluster_downsampled_no_anno@meta.data$B_clonotype_id = NULL
t.cell.cluster_downsampled_no_anno@meta.data$B_cdr3s_aa = NULL
t.cell.cluster_downsampled_no_anno@meta.data$integrated_snn_res.0.1 = NULL
t.cell.cluster_downsampled_no_anno@meta.data$integrated_snn_res.0.12 = NULL
t.cell.cluster_downsampled_no_anno@meta.data$integrated_snn_res.0.15 = NULL

saveRDS(t.cell.cluster_downsampled_no_anno, file = "./JIAsyno_CITEseq_T_share.rds")
```


---


# 用語集

| 用語 | 説明 |
| --- | --- |
| **Seurat Object** | 解析に必要な全データが入ったRのデータ構造。 |
| **Assay** | データの種類（RNA、ADTなど）のこと。 |
| **Metadata** | 細胞の由来（ドナー名）、疾患の状態などの付随情報。 |
| **Normalization** | 細胞ごとのデータ量のばらつきを補正する作業。 |
| **Clustering** | 遺伝子発現パターンが似ている細胞をグループ化すること。 |
| **UMAP** | 高次元のデータを人間が見やすい2次元平面に投影する手法。 |

---

# セッション情報

解析に使用した環境の記録です。

```{r}
sessionInfo()

```


---

# 次のステップ：

抜き出したT細胞だけを使用して、より詳細に解析する方法（Sub-clustering）してみましょう。

```