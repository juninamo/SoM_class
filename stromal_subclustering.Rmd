---
title: "JIA滑膜 CITE-seq: Stromal Cell Subclustering & Annotation"
author: "Seurat Analysis Pipeline"
date: "`r Sys.Date()`"
output:
  html_document:
    toc: true
    toc_float: true
    toc_depth: 3
    code_folding: show
    theme: flatly
    highlight: tango
    df_print: paged
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  echo = TRUE,
  warning = FALSE,
  message = FALSE,
  fig.width = 10,
  fig.height = 7,
  dpi = 150
)
```

# 1. ライブラリ読み込み

```{r libraries}
library(Seurat)
library(ggplot2)
library(dplyr)
library(patchwork)
library(RColorBrewer)
library(pheatmap)
library(harmony)
```

# 2. データ読み込みと Stromal Cell の抽出

## 2.1 全細胞データの読み込み

```{r load-data}
full_obj <- readRDS("JIAsyno_CITEseq_full.rds")

cat("=== Full Dataset ===\n")
cat("Cells:", ncol(full_obj), "\n")
cat("Genes:", nrow(full_obj), "\n")
cat("Assays:", paste(names(full_obj@assays), collapse = ", "), "\n")
```

## 2.2 Stromal Cell の定義と抽出

Stromal cellとして以下のカテゴリーを `global1` 列から抽出:

- **Fibroblasts** (~15,666 cells)
- **Endothelial** (~8,197 cells)
- **Pericytes** (~2,228 cells)
- **Lymphatic** (~532 cells)

```{r extract-stromal}
# Stromal cell types を定義
stromal_types <- c("Fibroblasts", "Endothelial", "Pericytes", "Lymphatic")

# global1 列に基づいてサブセット
stromal <- subset(full_obj, subset = global1 %in% stromal_types)

cat("=== Stromal Subset ===\n")
cat("Cells:", ncol(stromal), "\n")
cat("\nCell type composition:\n")
print(table(stromal$global1))
```

```{r original-annotation}
# 元の詳細アノテーション（ct_subtype）の確認
cat("=== Original Subtypes (ct_subtype) ===\n")
print(sort(table(stromal$ct_subtype), decreasing = TRUE))
```

## 2.3 元の全体UMAPでのStromal Cell位置

```{r plot-original-umap, fig.width=12, fig.height=5}
# 全体UMAPの中でStromal cellsをハイライト
full_obj$is_stromal <- ifelse(
  full_obj$global1 %in% stromal_types, 
  as.character(full_obj$global1), 
  "Other"
)

p1 <- DimPlot(full_obj, group.by = "is_stromal", 
              cols = c("Fibroblasts" = "#e74c3c", 
                       "Endothelial" = "#3498db",
                       "Pericytes" = "#2ecc71", 
                       "Lymphatic" = "#9b59b6",
                       "Other" = "grey90"),
              pt.size = 0.1, order = stromal_types) +
  ggtitle("Full UMAP: Stromal Cells Highlighted") +
  theme(plot.title = element_text(face = "bold"))

p1
```

# 3. Subclustering パイプライン

## 3.1 正規化と変動遺伝子の検出

```{r normalize}
# RNA assay で再正規化
DefaultAssay(stromal) <- "RNA"
stromal <- NormalizeData(stromal, verbose = FALSE)
stromal <- FindVariableFeatures(stromal, 
                                 selection.method = "vst", 
                                 nfeatures = 3000,
                                 verbose = FALSE)

cat("Variable features:", length(VariableFeatures(stromal)), "\n")
```

```{r variable-features-plot, fig.width=10, fig.height=5}
# Top variable features の表示
top20 <- head(VariableFeatures(stromal), 20)
p_vf <- VariableFeaturePlot(stromal)
p_vf <- LabelPoints(plot = p_vf, points = top20, repel = TRUE, xnudge = 0, ynudge = 0)
p_vf + ggtitle("Top Variable Features in Stromal Cells")
```

## 3.2 スケーリングとPCA

```{r scale-pca}
stromal <- ScaleData(stromal, verbose = FALSE)
stromal <- RunPCA(stromal, npcs = 50, verbose = FALSE)
```

```{r elbow-plot, fig.width=8, fig.height=5}
ElbowPlot(stromal, ndims = 50) +
  ggtitle("PCA Elbow Plot") +
  geom_vline(xintercept = 30, linetype = "dashed", color = "red") +
  annotate("text", x = 32, y = max(Stdev(stromal, reduction = "pca")) * 0.8,
           label = "PC30", color = "red")
```

```{r pca-dim-plot, fig.width=12, fig.height=5}
p_pca1 <- DimPlot(stromal, reduction = "pca", group.by = "global1") +
  ggtitle("PCA: by Cell Type")
p_pca2 <- DimPlot(stromal, reduction = "pca", group.by = "sample") +
  ggtitle("PCA: by Sample (before Harmony)")
p_pca1 + p_pca2
```

## 3.3 Harmony バッチ補正

`sample` をバッチ変数としてHarmonyで統合:

```{r harmony}
n_dims <- 30

stromal <- RunHarmony(stromal, 
                      group.by.vars = "sample",
                      verbose = FALSE)
```

```{r harmony-plot, fig.width=12, fig.height=5}
# Harmony補正後の埋め込みを確認
p_h1 <- DimPlot(stromal, reduction = "harmony", group.by = "global1") +
  ggtitle("Harmony: by Cell Type")
p_h2 <- DimPlot(stromal, reduction = "harmony", group.by = "sample") +
  ggtitle("Harmony: by Sample (after correction)")
p_h1 + p_h2
```

## 3.4 UMAP と クラスタリング（Harmony基準）

```{r umap-cluster}
# Harmony補正済み埋め込みからUMAP・近傍グラフを構築
stromal <- RunUMAP(stromal, reduction = "harmony", dims = 1:n_dims, verbose = FALSE)
stromal <- FindNeighbors(stromal, reduction = "harmony", dims = 1:n_dims, verbose = FALSE)
```

複数の解像度でクラスタリングを実行し、比較:

```{r multi-resolution}
resolutions <- c(0.3, 0.5, 0.8, 1.0)
for (res in resolutions) {
  stromal <- FindClusters(stromal, resolution = res, verbose = FALSE)
}

cat("Cluster counts by resolution:\n")
for (res in resolutions) {
  col <- paste0("RNA_snn_res.", res)
  cat(sprintf("  res=%.1f: %d clusters\n", res, length(unique(stromal@meta.data[[col]]))))
}
```

```{r resolution-comparison, fig.width=14, fig.height=10}
plots <- list()
for (res in resolutions) {
  col <- paste0("RNA_snn_res.", res)
  Idents(stromal) <- stromal@meta.data[[col]]
  plots[[as.character(res)]] <- DimPlot(stromal, label = TRUE, label.size = 4) +
    ggtitle(paste0("Resolution = ", res)) +
    NoLegend()
}
wrap_plots(plots, ncol = 2)
```

## 3.5 解像度の選択

```{r select-resolution}
# res=0.5をデフォルトとして使用（必要に応じて変更）
selected_res <- 0.5
Idents(stromal) <- stromal@meta.data[[paste0("RNA_snn_res.", selected_res)]]
stromal$seurat_clusters <- Idents(stromal)

cat("Selected resolution:", selected_res, "\n")
cat("Number of clusters:", length(unique(Idents(stromal))), "\n")
print(table(Idents(stromal)))
```

# 4. クラスター特性の評価

## 4.1 元のアノテーションとの対応

```{r cluster-vs-original, fig.width=12, fig.height=6}
# クラスターと元のglobal1の対応
p_ct1 <- DimPlot(stromal, group.by = "seurat_clusters", label = TRUE) +
  ggtitle("Subclusters") + NoLegend()
p_ct2 <- DimPlot(stromal, group.by = "global1") +
  ggtitle("Original Cell Type (global1)")
p_ct1 + p_ct2
```

```{r confusion-heatmap, fig.width=10, fig.height=6}
# クラスター vs 元アノテーション のクロス集計
ct_table <- table(stromal$seurat_clusters, stromal$global1)
ct_prop <- prop.table(ct_table, margin = 1)  # 行ごとの割合

pheatmap(ct_prop,
         color = colorRampPalette(c("white", "#3498db", "#e74c3c"))(50),
         cluster_rows = FALSE,
         cluster_cols = FALSE,
         display_numbers = TRUE,
         number_format = "%.2f",
         main = "Cluster Composition (proportion by global1)")
```

```{r confusion-ct-subtype, fig.width=14, fig.height=8}
# クラスター vs ct_subtype
ct2_table <- table(stromal$seurat_clusters, stromal$ct_subtype)
ct2_prop <- prop.table(ct2_table, margin = 1)

# 0でない列のみ残す
ct2_prop <- ct2_prop[, colSums(ct2_prop) > 0]

pheatmap(ct2_prop,
         color = colorRampPalette(c("white", "#2ecc71", "#8e44ad"))(50),
         cluster_rows = FALSE,
         cluster_cols = TRUE,
         display_numbers = TRUE,
         number_format = "%.2f",
         fontsize = 8,
         main = "Cluster Composition (proportion by ct_subtype)")
```

## 4.2 マーカー遺伝子の発現

```{r known-markers, fig.width=14, fig.height=10}
# Stromal cell の既知マーカー遺伝子
marker_genes <- c(
  # Fibroblasts (general)
  "COL1A1", "COL1A2", "DCN", "LUM", "VIM", "PDGFRA",
  # Fibroblast subtypes
  "CD34", "POSTN", "CXCL12", "CXCL14", "MMP1", "MMP3", "SOX5", "MKI67",
  # Endothelial
  "PECAM1", "VWF", "CDH5", "KDR", "ACKR1", "FLT1",
  # Pericytes / Mural cells
  "RGS5", "PDGFRB", "ACTA2", "MCAM", "NOTCH3",
  # Lymphatic
  "PROX1", "LYVE1", "PDPN", "FLT4", "CCL21"
)

# Seuratオブジェクトに存在する遺伝子のみフィルタ
marker_genes <- marker_genes[marker_genes %in% rownames(stromal)]

DotPlot(stromal, features = marker_genes, group.by = "seurat_clusters") +
  RotatedAxis() +
  ggtitle("Known Marker Genes by Cluster") +
  theme(axis.text.x = element_text(size = 9))
```

## 4.3 各クラスターのDEG（マーカー遺伝子検出）

```{r find-all-markers}
# 全クラスターのマーカー遺伝子を検出
all_markers <- FindAllMarkers(stromal,
                               only.pos = TRUE,
                               min.pct = 0.25,
                               logfc.threshold = 0.5,
                               verbose = FALSE)

cat("Total significant markers found:", nrow(all_markers), "\n")

# Top 5 per cluster
top5 <- all_markers %>%
  group_by(cluster) %>%
  slice_max(n = 5, order_by = avg_log2FC)
```

```{r marker-table}
# マーカー遺伝子テーブル表示
top5 %>%
  select(cluster, gene, avg_log2FC, pct.1, pct.2, p_val_adj) %>%
  arrange(cluster, desc(avg_log2FC))
```

```{r marker-heatmap, fig.width=12, fig.height=10}
# Top 3 マーカーのヒートマップ
top3 <- all_markers %>%
  group_by(cluster) %>%
  slice_max(n = 3, order_by = avg_log2FC) %>%
  pull(gene) %>%
  unique()

DoHeatmap(stromal, features = top3, size = 3) +
  ggtitle("Top 3 Markers per Cluster") +
  theme(axis.text.y = element_text(size = 7))
```

# 5. ADTデータの統合解析

```{r adt-analysis, fig.width=14, fig.height=8}
# ADT (表面タンパク質) データの確認
DefaultAssay(stromal) <- "ADT"
adt_features <- rownames(stromal[["ADT"]])
cat("Available ADT features:", length(adt_features), "\n")
cat(paste(head(adt_features, 30), collapse = ", "), "...\n")

# Stromal関連のADTマーカーを探す
stromal_adt <- c("CD31", "CD34", "CD90", "CD140a", "CD140b", "CD146", "CD54", "CD106")
available_adt <- stromal_adt[stromal_adt %in% adt_features]

if (length(available_adt) > 0) {
  # ADTの正規化
  stromal <- NormalizeData(stromal, normalization.method = "CLR", margin = 2, verbose = FALSE)
  
  cat("\nAvailable stromal ADT markers:", paste(available_adt, collapse = ", "), "\n")
  
  p_adt_plots <- FeaturePlot(stromal, features = available_adt, 
                              ncol = min(4, length(available_adt)),
                              reduction = "umap")
  print(p_adt_plots)
} else {
  cat("No stromal-specific ADT markers found. Showing available markers.\n")
  # 利用可能なADTの一部を表示
  show_adt <- head(adt_features, 8)
  stromal <- NormalizeData(stromal, normalization.method = "CLR", margin = 2, verbose = FALSE)
  FeaturePlot(stromal, features = show_adt, ncol = 4, reduction = "umap")
}

# RNA assayに戻す
DefaultAssay(stromal) <- "RNA"
```

# 6. アノテーション

## 6.1 手動アノテーション

マーカー遺伝子発現パターンとクラスター特性に基づいてアノテーションを付与。
以下は **テンプレート** であり、実際のクラスタリング結果に基づいて修正が必要:

```{r annotation}
# === アノテーション辞書 ===
# 各クラスター番号に対して、マーカー遺伝子の発現パターンから
# 細胞タイプ名を割り当てる。
# 
# 実行後のDotPlot・ヒートマップ・クロス集計表を参照して修正してください。

# --- ct_subtypeとの対応関係からアノテーションを推定 ---
# クラスターごとに最も多い ct_subtype を取得
cluster_annotation <- stromal@meta.data %>%
  group_by(seurat_clusters) %>%
  count(ct_subtype) %>%
  slice_max(n = 1, order_by = n) %>%
  select(seurat_clusters, ct_subtype)

cat("=== Auto-inferred annotation (majority vote from ct_subtype) ===\n")
print(as.data.frame(cluster_annotation))

# アノテーションを適用
annotation_map <- setNames(cluster_annotation$ct_subtype, 
                           cluster_annotation$seurat_clusters)
stromal$cell_type <- unname(annotation_map[as.character(stromal$seurat_clusters)])
```

```{r annotation-manual-override}
# === 手動修正セクション ===
# 上記の自動アノテーションが不適切なクラスターがあれば、
# 以下のように個別に修正してください。
#
# 例:
# stromal$cell_type[stromal$seurat_clusters == "5"] <- "Inflammatory Fibroblasts"
# stromal$cell_type[stromal$seurat_clusters == "10"] <- "Tip Endothelial Cells"
#
# 修正後に再度プロットを確認:

cat("=== Final Annotation ===\n")
print(table(stromal$cell_type))
```

## 6.2 アノテーション結果の可視化

```{r annotation-umap, fig.width=14, fig.height=6}
p_annot1 <- DimPlot(stromal, group.by = "seurat_clusters", label = TRUE) +
  ggtitle("Subclusters") + NoLegend()
p_annot2 <- DimPlot(stromal, group.by = "cell_type", label = TRUE, label.size = 3, repel = TRUE) +
  ggtitle("Annotated Cell Types") + NoLegend()
p_annot1 + p_annot2
```

```{r annotation-markers, fig.width=14, fig.height=10}
# アノテーションごとのマーカー発現
Idents(stromal) <- stromal$cell_type
DotPlot(stromal, features = marker_genes) +
  RotatedAxis() +
  ggtitle("Marker Expression by Annotated Cell Type")
```

# 7. サンプル間比較

```{r sample-composition, fig.width=12, fig.height=6}
# サンプルごとの細胞タイプ組成
comp_table <- table(stromal$sample, stromal$cell_type)
comp_prop <- prop.table(comp_table, margin = 1)

comp_df <- as.data.frame(comp_prop)
names(comp_df) <- c("Sample", "CellType", "Proportion")

ggplot(comp_df, aes(x = Sample, y = Proportion, fill = CellType)) +
  geom_bar(stat = "identity", position = "stack") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  ggtitle("Cell Type Composition by Sample") +
  scale_fill_brewer(palette = "Set3")
```

```{r clinical-comparison, fig.width=12, fig.height=6}
# 臨床群（ana）ごとの比較
if ("ana" %in% names(stromal@meta.data)) {
  comp_ana <- table(stromal$ana, stromal$cell_type)
  comp_ana_prop <- prop.table(comp_ana, margin = 1)
  
  ana_df <- as.data.frame(comp_ana_prop)
  names(ana_df) <- c("ANA_Status", "CellType", "Proportion")
  
  ggplot(ana_df, aes(x = ANA_Status, y = Proportion, fill = CellType)) +
    geom_bar(stat = "identity", position = "stack") +
    theme_minimal() +
    ggtitle("Cell Type Composition by ANA Status") +
    scale_fill_brewer(palette = "Set3")
}
```

# 8. 結果の保存

```{r save-results}
# Stromal サブセットオブジェクトを保存
saveRDS(stromal, "JIAsyno_stromal_subclustered.rds")
cat("Saved: JIAsyno_stromal_subclustered.rds\n")

# マーカー遺伝子リストを保存
write.csv(all_markers, "stromal_all_markers.csv", row.names = FALSE)
cat("Saved: stromal_all_markers.csv\n")

# アノテーション情報を保存
annotation_df <- stromal@meta.data %>%
  select(seurat_clusters, cell_type, global1, ct_subtype) %>%
  distinct(seurat_clusters, .keep_all = TRUE) %>%
  arrange(as.numeric(as.character(seurat_clusters)))
write.csv(annotation_df, "stromal_annotation.csv", row.names = FALSE)
cat("Saved: stromal_annotation.csv\n")
```

# 9. セッション情報

```{r session-info}
sessionInfo()
```
